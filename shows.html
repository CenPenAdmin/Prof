<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Show Manager - Prof Radio</title>
  <style>
    body {
      background: linear-gradient(135deg, #ff6699, #9933ff, #3399ff);
      font-family: 'Trebuchet MS', sans-serif;
      padding: 20px;
      color: #fff;
      min-height: 100vh;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    .header {
      text-align: center;
      margin-bottom: 40px;
    }
    .header h1 {
      font-size: 2.5rem;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      margin: 0;
    }
    .back-link {
      display: inline-block;
      margin-bottom: 20px;
      color: #fff;
      text-decoration: underline;
      cursor: pointer;
      font-size: 1.1rem;
    }
    .show-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .show-card {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
      transition: transform 0.3s ease;
      position: relative;
    }
    .show-card:hover {
      transform: translateY(-5px);
    }
    .show-title {
      font-size: 1.3rem;
      font-weight: bold;
      margin-bottom: 10px;
      color: #FFD700;
    }
    .show-owner {
      color: #FF69B4;
      margin-bottom: 10px;
    }
    .show-description {
      margin-bottom: 15px;
      opacity: 0.9;
    }
    .show-stats {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
      font-size: 0.9rem;
    }
    .show-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .show-collaborators {
      margin: 10px 0;
      font-size: 0.9rem;
      color: #87CEEB;
    }
    .show-slot {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0, 255, 0, 0.3);
      padding: 3px 8px;
      border-radius: 10px;
      font-size: 0.8rem;
      color: #00FF00;
    }
    .upload-section {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      display: none;
    }
    .file-input {
      margin: 20px 0;
    }
    .file-input input[type="file"] {
      display: none;
    }
    .file-input label {
      display: inline-block;
      padding: 12px 24px;
      background: rgba(255, 255, 255, 0.2);
      border: 2px dashed rgba(255, 255, 255, 0.5);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .file-input label:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    .progress-bar {
      width: 100%;
      height: 6px;
      background: rgba(255,255,255,0.2);
      border-radius: 3px;
      margin: 10px 0;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #00ff88, #00ccff);
      width: 0%;
      transition: width 0.3s ease;
    }
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s ease;
    }
    .btn-primary {
      background: rgba(255, 255, 255, 0.2);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    .btn-primary:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    .btn-success {
      background: rgba(0, 255, 0, 0.2);
      color: #fff;
      border: 1px solid rgba(0, 255, 0, 0.3);
    }
    .create-show {
      text-align: center;
      margin-bottom: 30px;
    }
    .create-show .btn {
      padding: 15px 30px;
      font-size: 1.1rem;
    }
    .loading {
      text-align: center;
      font-size: 1.2rem;
      margin: 50px 0;
    }
    .status-draft {
      background: rgba(255, 165, 0, 0.3);
      color: #FFA500;
      padding: 3px 8px;
      border-radius: 10px;
      font-size: 0.8rem;
    }
    .status-published {
      background: rgba(0, 255, 0, 0.3);
      color: #00FF00;
      padding: 3px 8px;
      border-radius: 10px;
      font-size: 0.8rem;
    }
    
    .edit-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      z-index: 1000;
    }
    
    .edit-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(135deg, #ff6699, #9933ff, #3399ff);
      border-radius: 15px;
      padding: 30px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      color: white;
    }
    
    .edit-section {
      margin-bottom: 25px;
    }
    
    .edit-section h3 {
      margin-bottom: 15px;
      color: #FFD700;
    }
    
    .track-item {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .track-info {
      flex: 1;
    }
    
    .track-title {
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .track-details {
      font-size: 0.9rem;
      opacity: 0.8;
    }
    
    .track-actions {
      display: flex;
      gap: 10px;
    }
    
    .slot-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 10px;
      margin: 15px 0;
    }
    
    .slot-item {
      padding: 10px;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.8rem;
    }
    
    .slot-available {
      background: rgba(0, 255, 0, 0.2);
      border: 1px solid rgba(0, 255, 0, 0.5);
      color: #00FF00;
    }
    
    .slot-available:hover {
      background: rgba(0, 255, 0, 0.3);
    }
    
    .slot-occupied {
      background: rgba(255, 0, 0, 0.2);
      border: 1px solid rgba(255, 0, 0, 0.5);
      color: #FF6666;
      cursor: not-allowed;
    }
    
    .slot-current {
      background: rgba(255, 215, 0, 0.3);
      border: 2px solid #FFD700;
      color: #FFD700;
    }
    
    .slot-selected {
      background: rgba(0, 150, 255, 0.3);
      border: 2px solid #0096FF;
      color: #0096FF;
    }
    
    .edit-form input, .edit-form select {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: none;
      border-radius: 5px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .edit-form input::placeholder {
      color: rgba(255, 255, 255, 0.7);
    }
    
    .add-song-section {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      padding: 15px;
      margin: 15px 0;
      border: 2px dashed rgba(255, 255, 255, 0.3);
    }
    
    .file-upload-area {
      text-align: center;
      padding: 20px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
      cursor: pointer;
      transition: background 0.3s ease;
    }
    
    .file-upload-area:hover {
      background: rgba(255, 255, 255, 0.15);
    }
    
    .file-upload-area.dragover {
      background: rgba(0, 255, 0, 0.1);
      border-color: #00FF00;
    }
  </style>
</head>
<body>
  <div class="container">
    <a class="back-link" onclick="goBack()">‚Üê Back to Profile</a>
    
    <div class="header">
      <h1>üéµ Show Manager</h1>
      <p>Create and manage your radio shows</p>
    </div>

    <div class="create-show">
      <button class="btn btn-success" onclick="createNewShow()">
        ‚ûï Create New Show
      </button>
      <button class="btn btn-primary" onclick="viewSchedule()">
        üìÖ View Schedule
      </button>
    </div>

    <!-- Audio Upload Section -->
    <div id="uploadSection" class="upload-section">
      <h3>Upload Audio to Show</h3>
      <div>
        <select id="showSelect" style="width: 100%; padding: 10px; margin: 10px 0; border-radius: 5px; border: none;">
          <option value="">Select a show...</option>
        </select>
      </div>
      <div class="file-input">
        <label for="audioFile">
          üéµ Choose Audio File (MP3, WAV, M4A)
        </label>
        <input type="file" id="audioFile" accept=".mp3,.wav,.m4a" onchange="handleFileSelect(event)">
      </div>
      
      <div id="uploadInfo" style="display: none;">
        <input type="text" id="songTitle" placeholder="Song Title" style="margin: 5px; padding: 10px; border-radius: 5px; border: none; width: 200px;">
        <input type="text" id="artistName" placeholder="Artist Name" style="margin: 5px; padding: 10px; border-radius: 5px; border: none; width: 200px;">
        <br>
        <button class="btn btn-success" onclick="uploadAudio()">üéµ Upload to Show</button>
        <button class="btn btn-primary" onclick="cancelUpload()">‚ùå Cancel</button>
        
        <div id="uploadProgress" style="display: none;">
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
          </div>
          <p id="uploadStatus">Uploading...</p>
        </div>
      </div>
    </div>

    <div id="loading" class="loading">
      üì° Loading your shows...
    </div>

    <div id="showsContainer" class="show-grid" style="display: none;">
      <!-- Shows will be loaded here -->
    </div>
    
    <!-- Edit Show Modal -->
    <div id="editModal" class="edit-modal">
      <div class="edit-content">
        <h2>‚úèÔ∏è Edit Show</h2>
        
        <div class="edit-section">
          <h3>Show Details</h3>
          <div class="edit-form">
            <input type="text" id="editTitle" placeholder="Show Title">
            <input type="text" id="editDescription" placeholder="Show Description">
          </div>
        </div>
        
        <div class="edit-section">
          <h3>Time Slot Assignment</h3>
          <p>Current slot: <span id="currentSlot">-</span></p>
          <p>Select a new time slot (one slot per 24 hours allowed):</p>
          <div id="slotGrid" class="slot-grid">
            <!-- Time slots will be loaded here -->
          </div>
        </div>
        
        <div class="edit-section">
          <h3>Add New Song</h3>
          <div class="add-song-section">
            <div class="file-upload-area" id="editFileUpload">
              <p>üéµ Click or drag to add new song</p>
              <p style="font-size: 0.8rem; opacity: 0.7;">MP3, WAV, M4A files supported</p>
            </div>
            <input type="file" id="editAudioFile" accept=".mp3,.wav,.m4a" style="display: none;">
            
            <div id="editUploadInfo" style="display: none; margin-top: 15px;">
              <input type="text" id="editSongTitle" placeholder="Song Title" style="width: 48%; margin: 5px 1%;">
              <input type="text" id="editArtistName" placeholder="Artist Name" style="width: 48%; margin: 5px 1%;">
              <br>
              <button class="btn btn-success" onclick="addSongToShow()">üéµ Add to Show</button>
              <button class="btn btn-primary" onclick="cancelEditUpload()">‚ùå Cancel</button>
              
              <div id="editUploadProgress" style="display: none;">
                <div class="progress-bar">
                  <div class="progress-fill" id="editProgressFill"></div>
                </div>
                <p id="editUploadStatus">Uploading...</p>
              </div>
            </div>
          </div>
        </div>
        
        <div class="edit-section">
          <h3>Track List</h3>
          <div id="trackList">
            <!-- Tracks will be loaded here -->
          </div>
        </div>
        
        <div class="edit-section">
          <button class="btn btn-success" onclick="saveShowEdits()">üíæ Save Changes</button>
          <button class="btn btn-primary" onclick="closeEditModal()">‚ùå Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Get user info from URL params
    const params = new URLSearchParams(window.location.search);
    const userEmail = params.get("email");
    const userName = params.get("name");
    let selectedFile = null;
    let userShows = [];
    let currentEditingShow = null;
    let selectedSlot = null;
    let availableSlots = [];
    let editSelectedFile = null;

    function goBack() {
      if (userEmail) {
        window.location.href = `/profile.html?email=${encodeURIComponent(userEmail)}`;
      } else {
        window.location.href = '/profile.html';
      }
    }

    function formatDate(dateString) {
      return new Date(dateString).toLocaleDateString();
    }

    function loadShows() {
      const baseUrl = `${window.location.protocol}//${window.location.host}`;
      let apiUrl = `${baseUrl}/api/shows`;
      
      // Filter by user email if available
      if (userEmail) {
        apiUrl += `?owner=${encodeURIComponent(userEmail)}`;
      }

      console.log('üîç Loading shows from:', apiUrl);
      console.log('üìß User email:', userEmail);
      console.log('üåç Window location:', window.location.href);

      // Show loading status
      document.getElementById('loading').innerHTML = 'üì° Loading shows from: ' + apiUrl;

      fetch(apiUrl)
        .then(response => {
          console.log('üì° Response status:', response.status);
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          return response.json();
        })
        .then(data => {
          console.log('üìã API response:', data);
          document.getElementById('loading').style.display = 'none';
          document.getElementById('showsContainer').style.display = 'grid';

          if (data.success && data.shows.length > 0) {
            userShows = data.shows;
            displayShows(data.shows);
            populateShowSelect(data.shows);
          } else {
            document.getElementById('showsContainer').innerHTML = `
              <div style="grid-column: 1 / -1; text-align: center; margin: 50px 0;">
                <h3>No shows yet</h3>
              </div>
            `;
          }
        })
        .catch(error => {
          console.error('Error loading shows:', error);
          document.getElementById('loading').innerHTML = `‚ùå Error loading shows: ${error.message}`;
          document.getElementById('showsContainer').innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; margin: 50px 0;">
              <h3>Error loading shows</h3>
              <p>${error.message}</p>
              <p style="font-size: 0.8rem;">API URL: ${apiUrl}</p>
            </div>
          `;
        });
    }

    function populateShowSelect(shows) {
      const select = document.getElementById('showSelect');
      select.innerHTML = '<option value="">Select a show...</option>';
      
      shows.forEach(show => {
        const option = document.createElement('option');
        option.value = show.id;
        option.textContent = show.title;
        select.appendChild(option);
      });
    }

    function displayShows(shows) {
      const container = document.getElementById('showsContainer');
      
      container.innerHTML = shows.map(show => `
        <div class="show-card">
          <div class="show-slot">Slot ${show.scheduledSlot || 'TBD'}</div>
          <div class="show-title">${show.title}</div>
          <div class="show-owner">DJ: ${show.owner.replace('%40', '@')}</div>
          <div class="show-description">${show.description || 'No description'}</div>
          
          ${show.collaborators && show.collaborators.length > 0 ? 
            `<div class="show-collaborators">
              üë• Collaborators: ${show.collaborators.map(c => c.replace('%40', '@')).join(', ')}
            </div>` : ''}
          
          <div class="show-stats">
            <span class="status-${show.status}">${show.status.toUpperCase()}</span>
          </div>
          
          <div class="show-stats">
            <span>üéµ ${show.playlist?.length || 0} tracks</span>
            <span>üëÇ ${show.plays} plays</span>
            <span>üìÖ ${formatDate(show.created)}</span>
          </div>
          
          <div class="show-actions">
            <button class="btn btn-primary" onclick="editShow('${show.id}')">
              ‚úèÔ∏è Edit
            </button>
            <button class="btn btn-primary" onclick="addContent('${show.id}')">
              üéµ Add Music
            </button>
            ${!show.isCollaborative ? 
              `<button class="btn btn-primary" onclick="inviteCollaborator('${show.id}')">
                üë• Invite
              </button>` : ''}
            <button class="btn" onclick="deleteShowFromCard('${show.id}')" style="background: rgba(255, 0, 0, 0.2); color: #fff; border: 1px solid rgba(255, 0, 0, 0.3);">
              üóëÔ∏è Delete
            </button>
          </div>
        </div>
      `).join('');
    }

    function createNewShow() {
      const showTitle = prompt('Enter show title:');
      if (!showTitle) {
        alert('Show title is required!');
        return;
      }

      const djName = prompt('Enter DJ name (how you want to appear on air):');
      if (!djName) {
        alert('DJ name is required!');
        return;
      }

      const showDescription = prompt('Enter show description (optional):') || '';
      const isCollaborative = confirm('Allow collaborators to add content to this show?');

      const showData = {
        title: showTitle,
        description: showDescription,
        djName: djName,
        owner: userEmail || 'g.drizzle@cap',
        playlist: [],
        isCollaborative: isCollaborative
      };

      fetch(`${window.location.protocol}//${window.location.host}/api/shows`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(showData)
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert(`Show "${showTitle}" created successfully and scheduled for slot ${data.show.scheduledSlot}!`);
          loadShows(); // Reload the shows
        } else {
          alert('Error creating show: ' + data.error);
        }
      })
      .catch(error => {
        console.error('Error creating show:', error);
        alert('Error creating show');
      });
    }

    function addContent(showId) {
      document.getElementById('showSelect').value = showId;
      document.getElementById('uploadSection').style.display = 'block';
      document.getElementById('uploadSection').scrollIntoView({ behavior: 'smooth' });
    }

    function inviteCollaborator(showId) {
      const collaboratorEmail = prompt('Enter collaborator email:');
      if (!collaboratorEmail) return;

      fetch(`${window.location.protocol}//${window.location.host}/api/shows/${showId}/invite`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ collaboratorEmail })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('Invitation sent successfully!');
        } else {
          alert('Error sending invitation: ' + data.error);
        }
      })
      .catch(error => {
        console.error('Error sending invitation:', error);
        alert('Error sending invitation');
      });
    }

    function viewSchedule() {
      fetch(`${window.location.protocol}//${window.location.host}/api/schedule`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            let scheduleText = 'Radio Station Schedule (Eastern Time):\n\n';
            data.schedule.forEach(slot => {
              const status = slot.showId ? `"${slot.showTitle}" by ${slot.showOwner}` : 'Available';
              scheduleText += `${formatSlotTime(slot.slot)} - ${status}\n`;
            });
            alert(scheduleText);
          } else {
            alert('Error loading schedule');
          }
        });
    }

    function handleFileSelect(event) {
      selectedFile = event.target.files[0];
      console.log('üìÅ File selected:', selectedFile ? selectedFile.name : 'None');
      
      if (selectedFile) {
        console.log('üìã File details:', {
          name: selectedFile.name,
          size: selectedFile.size,
          type: selectedFile.type,
          lastModified: selectedFile.lastModified
        });

        // Validate file size (50MB limit)
        const maxSize = 50 * 1024 * 1024; // 50MB
        if (selectedFile.size > maxSize) {
          alert(`File too large! Maximum size is 50MB. Your file is ${Math.round(selectedFile.size / 1024 / 1024)}MB.`);
          event.target.value = '';
          selectedFile = null;
          return;
        }

        // Validate file type
        const allowedTypes = ['audio/mpeg', 'audio/mp3', 'audio/wav', 'audio/x-wav', 'audio/mp4', 'audio/m4a'];
        const fileExtension = selectedFile.name.toLowerCase().split('.').pop();
        const allowedExtensions = ['mp3', 'wav', 'm4a'];
        
        if (!allowedTypes.includes(selectedFile.type) && !allowedExtensions.includes(fileExtension)) {
          alert(`Unsupported file type! Please use MP3, WAV, or M4A files.\n\nYour file type: ${selectedFile.type || 'Unknown'}\nFile extension: ${fileExtension}`);
          event.target.value = '';
          selectedFile = null;
          return;
        }

        document.getElementById('uploadInfo').style.display = 'block';
        
        // Extract title from filename
        const fileName = selectedFile.name.replace(/\.[^/.]+$/, "");
        document.getElementById('songTitle').value = fileName;
        document.getElementById('artistName').value = userEmail ? userEmail.replace('%40', '@') : '';
        
        console.log('‚úÖ File validated and info populated');
      } else {
        document.getElementById('uploadInfo').style.display = 'none';
        console.log('‚ùå No file selected');
      }
    }

    function uploadAudio() {
      const showId = document.getElementById('showSelect').value;
      const title = document.getElementById('songTitle').value;
      const artist = document.getElementById('artistName').value;

      console.log('üéµ Starting upload with:', { showId, title, artist, userEmail, fileSelected: !!selectedFile });

      if (!showId) {
        alert('Please select a show');
        return;
      }

      if (!selectedFile) {
        alert('Please select an audio file');
        return;
      }

      if (!title) {
        alert('Please enter a song title');
        return;
      }

      if (!userEmail) {
        alert('User email not available. Please refresh the page.');
        return;
      }

      const formData = new FormData();
      formData.append('audioFile', selectedFile);
      formData.append('showId', showId);
      formData.append('title', title);
      formData.append('artist', artist || userEmail);
      formData.append('userEmail', userEmail);

      console.log('üì§ FormData prepared, starting upload...');

      // Show progress
      document.getElementById('uploadProgress').style.display = 'block';
      document.getElementById('uploadStatus').textContent = 'Uploading...';
      
      let progress = 0;
      const progressInterval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress > 90) progress = 90;
        document.getElementById('progressFill').style.width = progress + '%';
      }, 200);

      fetch(`${window.location.protocol}//${window.location.host}/api/upload-audio`, {
        method: 'POST',
        body: formData
      })
      .then(response => {
        console.log('üì° Response received:', response.status, response.statusText);
        return response.json().then(data => ({ status: response.status, data }));
      })
      .then(({ status, data }) => {
        clearInterval(progressInterval);
        document.getElementById('progressFill').style.width = '100%';
        
        console.log('üìã Upload response:', { status, data });
        
        if (data.success) {
          document.getElementById('uploadStatus').textContent = 'Upload successful!';
          setTimeout(() => {
            alert(`Audio "${title}" uploaded successfully to show!\n\nShow now has ${data.show.trackCount} tracks.`);
            cancelUpload();
            loadShows(); // Reload shows to update display
          }, 1000);
        } else {
          document.getElementById('uploadStatus').textContent = 'Upload failed!';
          let errorMessage = 'Upload failed: ' + (data.error || 'Unknown error');
          
          if (data.details) {
            errorMessage += '\n\nDetails:\n';
            if (typeof data.details === 'object') {
              for (const [key, value] of Object.entries(data.details)) {
                errorMessage += `${key}: ${value}\n`;
              }
            } else {
              errorMessage += data.details;
            }
          }
          
          console.error('‚ùå Upload failed:', data);
          alert(errorMessage);
        }
      })
      .catch(error => {
        clearInterval(progressInterval);
        console.error('üí• Upload error:', error);
        document.getElementById('uploadStatus').textContent = 'Upload failed!';
        alert(`Network error during upload: ${error.message}\n\nPlease check:\n- Internet connection\n- Server status\n- File size (max ~50MB recommended)`);
      });
    }

    function cancelUpload() {
      document.getElementById('uploadSection').style.display = 'none';
      document.getElementById('uploadInfo').style.display = 'none';
      document.getElementById('uploadProgress').style.display = 'none';
      document.getElementById('audioFile').value = '';
      document.getElementById('showSelect').value = '';
      document.getElementById('songTitle').value = '';
      document.getElementById('artistName').value = '';
      selectedFile = null;
    }

    function editShow(showId) {
      const show = userShows.find(s => s.id === showId);
      if (!show) {
        alert('Show not found!');
        return;
      }
      
      currentEditingShow = show;
      selectedSlot = show.scheduledSlot;
      
      // Populate form fields
      document.getElementById('editTitle').value = show.title;
      document.getElementById('editDescription').value = show.description || '';
      document.getElementById('currentSlot').textContent = `Slot ${show.scheduledSlot} (${formatSlotTime(show.scheduledSlot)} ET)`;
      
      // Load schedule data and display modal
      loadScheduleForEdit(show);
      loadTrackList(show);
      document.getElementById('editModal').style.display = 'block';
    }

    function loadScheduleForEdit(currentShow) {
      fetch(`${window.location.protocol}//${window.location.host}/api/schedule`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            availableSlots = data.schedule;
            displaySlotGrid(currentShow);
          } else {
            alert('Error loading schedule');
          }
        })
        .catch(error => {
          console.error('Error loading schedule:', error);
          alert('Error loading schedule');
        });
    }

    function displaySlotGrid(currentShow) {
      const grid = document.getElementById('slotGrid');
      grid.innerHTML = '';
      
      // Check if user already has a show in any other slot
      const userOtherShows = userShows.filter(s => s.id !== currentShow.id);
      const userOccupiedSlots = userOtherShows.map(s => s.scheduledSlot);
      
      availableSlots.forEach(slot => {
        const slotDiv = document.createElement('div');
        slotDiv.className = 'slot-item';
        slotDiv.textContent = `${slot.time}:00`;
        
        if (slot.slot === currentShow.scheduledSlot) {
          // Current slot
          slotDiv.classList.add('slot-current');
          slotDiv.title = 'Current slot';
        } else if (slot.showId && slot.showId !== currentShow.id) {
          // Occupied by another show
          slotDiv.classList.add('slot-occupied');
          slotDiv.title = `Occupied by "${slot.showTitle || 'Another show'}"`;
        } else if (userOccupiedSlots.includes(slot.slot)) {
          // User already has a show in this slot
          slotDiv.classList.add('slot-occupied');
          slotDiv.title = 'You already have a show in this time period';
        } else {
          // Available
          slotDiv.classList.add('slot-available');
          slotDiv.title = 'Available - Click to select';
          slotDiv.onclick = () => selectSlot(slot.slot, slotDiv);
        }
        
        grid.appendChild(slotDiv);
      });
    }

    function selectSlot(slotNumber, slotElement) {
      // Remove previous selection
      document.querySelectorAll('.slot-selected').forEach(el => {
        el.classList.remove('slot-selected');
        el.classList.add('slot-available');
      });
      
      // Select new slot
      slotElement.classList.remove('slot-available');
      slotElement.classList.add('slot-selected');
      selectedSlot = slotNumber;
    }

    function loadTrackList(show) {
      const trackListDiv = document.getElementById('trackList');
      
      if (!show.playlist || show.playlist.length === 0) {
        trackListDiv.innerHTML = '<p>No tracks in this show yet.</p>';
      } else {
        trackListDiv.innerHTML = show.playlist.map((track, index) => `
          <div class="track-item" data-track-id="${track.id}">
            <div class="track-info">
              <div class="track-title">${track.title}</div>
              <div class="track-details">
                Artist: ${track.artist}
              </div>
            </div>
            <div class="track-actions">
              <button class="btn btn-primary" onclick="moveTrackUp('${track.id}', ${index})" ${index === 0 ? 'disabled' : ''}>
                ‚¨ÜÔ∏è
              </button>
              <button class="btn btn-primary" onclick="moveTrackDown('${track.id}', ${index})" ${index === show.playlist.length - 1 ? 'disabled' : ''}>
                ‚¨áÔ∏è
              </button>
              <button class="btn btn-primary" onclick="removeTrack('${track.id}')">
                üóëÔ∏è
              </button>
            </div>
          </div>
        `).join('');
      }
      
      // Setup file upload area
      setupEditFileUpload();
    }

    function setupEditFileUpload() {
      const uploadArea = document.getElementById('editFileUpload');
      const fileInput = document.getElementById('editAudioFile');
      
      // Click to upload
      uploadArea.onclick = () => fileInput.click();
      
      // Drag and drop
      uploadArea.ondragover = (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
      };
      
      uploadArea.ondragleave = () => {
        uploadArea.classList.remove('dragover');
      };
      
      uploadArea.ondrop = (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          fileInput.files = files;
          handleEditFileSelect({ target: { files: files } });
        }
      };
      
      // File input change
      fileInput.onchange = handleEditFileSelect;
    }

    function handleEditFileSelect(event) {
      editSelectedFile = event.target.files[0];
      console.log('üìÅ Edit file selected:', editSelectedFile ? editSelectedFile.name : 'None');
      
      if (editSelectedFile) {
        // Validate file size (50MB limit)
        const maxSize = 50 * 1024 * 1024;
        if (editSelectedFile.size > maxSize) {
          alert(`File too large! Maximum size is 50MB. Your file is ${Math.round(editSelectedFile.size / 1024 / 1024)}MB.`);
          editSelectedFile = null;
          return;
        }

        // Validate file type
        const allowedTypes = ['audio/mpeg', 'audio/mp3', 'audio/wav', 'audio/x-wav', 'audio/mp4', 'audio/m4a'];
        const fileExtension = editSelectedFile.name.toLowerCase().split('.').pop();
        const allowedExtensions = ['mp3', 'wav', 'm4a'];
        
        if (!allowedTypes.includes(editSelectedFile.type) && !allowedExtensions.includes(fileExtension)) {
          alert(`Unsupported file type! Please use MP3, WAV, or M4A files.\n\nYour file type: ${editSelectedFile.type || 'Unknown'}\nFile extension: ${fileExtension}`);
          editSelectedFile = null;
          return;
        }

        document.getElementById('editUploadInfo').style.display = 'block';
        
        // Extract title from filename
        const fileName = editSelectedFile.name.replace(/\.[^/.]+$/, "");
        document.getElementById('editSongTitle').value = fileName;
        document.getElementById('editArtistName').value = userEmail ? userEmail.replace('%40', '@') : '';
        
        console.log('‚úÖ Edit file validated and info populated');
      }
    }

    function addSongToShow() {
      const title = document.getElementById('editSongTitle').value.trim();
      const artist = document.getElementById('editArtistName').value.trim();

      if (!editSelectedFile) {
        alert('Please select an audio file');
        return;
      }

      if (!title) {
        alert('Please enter a song title');
        return;
      }

      const formData = new FormData();
      formData.append('audioFile', editSelectedFile);
      formData.append('showId', currentEditingShow.id);
      formData.append('title', title);
      formData.append('artist', artist || userEmail);
      formData.append('userEmail', userEmail);

      // Show progress
      document.getElementById('editUploadProgress').style.display = 'block';
      document.getElementById('editUploadStatus').textContent = 'Uploading...';
      
      let progress = 0;
      const progressInterval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress > 90) progress = 90;
        document.getElementById('editProgressFill').style.width = progress + '%';
      }, 200);

      fetch(`${window.location.protocol}//${window.location.host}/api/upload-audio`, {
        method: 'POST',
        body: formData
      })
      .then(response => response.json().then(data => ({ status: response.status, data })))
      .then(({ status, data }) => {
        clearInterval(progressInterval);
        document.getElementById('editProgressFill').style.width = '100%';
        
        if (data.success) {
          document.getElementById('editUploadStatus').textContent = 'Upload successful!';
          
          // Update the current editing show with new track
          const newTrack = {
            id: `item_${Date.now()}`,
            type: 'music',
            file: `uploads/${encodeURIComponent(userEmail)}/music/${Date.now()}_${title.replace(/[^a-zA-Z0-9]/g, '_')}.mp3`,
            title: title,
            artist: artist,
            owner: userEmail,
            uploadedBy: userEmail,
            order: currentEditingShow.playlist.length + 1
          };
          
          currentEditingShow.playlist.push(newTrack);
          
          setTimeout(() => {
            alert(`"${title}" added to show successfully!`);
            cancelEditUpload();
            loadTrackList(currentEditingShow);
          }, 1000);
        } else {
          document.getElementById('editUploadStatus').textContent = 'Upload failed!';
          alert('Upload failed: ' + (data.error || 'Unknown error'));
        }
      })
      .catch(error => {
        clearInterval(progressInterval);
        console.error('Upload error:', error);
        alert('Network error during upload: ' + error.message);
      });
    }

    function cancelEditUpload() {
      document.getElementById('editUploadInfo').style.display = 'none';
      document.getElementById('editUploadProgress').style.display = 'none';
      document.getElementById('editAudioFile').value = '';
      document.getElementById('editSongTitle').value = '';
      document.getElementById('editArtistName').value = '';
      editSelectedFile = null;
    }

    function moveTrackUp(trackId, currentIndex) {
      if (currentIndex <= 0) return;
      
      const playlist = currentEditingShow.playlist;
      const track = playlist[currentIndex];
      const previousTrack = playlist[currentIndex - 1];
      
      // Swap tracks
      playlist[currentIndex] = previousTrack;
      playlist[currentIndex - 1] = track;
      
      // Update order and startTime
      updatePlaylistOrder(playlist);
      loadTrackList(currentEditingShow);
    }

    function moveTrackDown(trackId, currentIndex) {
      const playlist = currentEditingShow.playlist;
      if (currentIndex >= playlist.length - 1) return;
      
      const track = playlist[currentIndex];
      const nextTrack = playlist[currentIndex + 1];
      
      // Swap tracks
      playlist[currentIndex] = nextTrack;
      playlist[currentIndex + 1] = track;
      
      // Update order and startTime
      updatePlaylistOrder(playlist);
      loadTrackList(currentEditingShow);
    }

    function removeTrack(trackId) {
      if (!confirm('Are you sure you want to remove this track?')) return;
      
      currentEditingShow.playlist = currentEditingShow.playlist.filter(track => track.id !== trackId);
      updatePlaylistOrder(currentEditingShow.playlist);
      
      loadTrackList(currentEditingShow);
    }

    function updatePlaylistOrder(playlist) {
      playlist.forEach((track, index) => {
        track.order = index + 1;
      });
    }

    function formatSlotTime(slot) {
      // Pennsylvania is Eastern Time
      const hour = parseInt(slot);
      let displayHour = hour;
      let period = 'AM';
      
      if (hour === 0) {
        displayHour = 12;
        period = 'AM';
      } else if (hour === 12) {
        displayHour = 12;
        period = 'PM';
      } else if (hour > 12) {
        displayHour = hour - 12;
        period = 'PM';
      }
      
      return `${displayHour}:00 ${period}`;
    }

    function saveShowEdits() {
      if (!currentEditingShow) return;
      
      const newTitle = document.getElementById('editTitle').value.trim();
      const newDescription = document.getElementById('editDescription').value.trim();
      
      if (!newTitle) {
        alert('Show title is required!');
        return;
      }
      
      // Prepare update data
      const updateData = {
        title: newTitle,
        description: newDescription,
        playlist: currentEditingShow.playlist
      };
      
      // Add slot change if different
      if (selectedSlot !== currentEditingShow.scheduledSlot) {
        updateData.newSlot = selectedSlot;
      }
      
      // Send update request
      fetch(`${window.location.protocol}//${window.location.host}/api/shows/${currentEditingShow.id}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(updateData)
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('Show updated successfully!');
          closeEditModal();
          loadShows(); // Reload shows
        } else {
          alert('Error updating show: ' + data.error);
        }
      })
      .catch(error => {
        console.error('Error updating show:', error);
        alert('Error updating show');
      });
    }

    function closeEditModal() {
      document.getElementById('editModal').style.display = 'none';
      currentEditingShow = null;
      selectedSlot = null;
      cancelEditUpload();
    }

    function deleteShow() {
      if (!currentEditingShow) return;
      
      const showTitle = currentEditingShow.title;
      const confirmMessage = `Are you sure you want to DELETE "${showTitle}"?\n\nThis will:\n- Remove the show completely\n- Delete all uploaded tracks\n- Free up the time slot\n- This action CANNOT be undone!\n\nType "DELETE" to confirm:`;
      
      const confirmation = prompt(confirmMessage);
      
      if (confirmation !== 'DELETE') {
        alert('Show deletion cancelled.');
        return;
      }
      
      console.log('üóëÔ∏è Starting delete request for show:', currentEditingShow.id, 'by user:', userEmail);
      
      // Send delete request
      fetch(`${window.location.protocol}//${window.location.host}/api/shows/${currentEditingShow.id}`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ userEmail: userEmail })
      })
      .then(response => {
        console.log('üóëÔ∏è Delete response status:', response.status, response.statusText);
        return response.json();
      })
      .then(data => {
        console.log('üóëÔ∏è Delete response data:', data);
        if (data.success) {
          alert(`Show "${showTitle}" has been deleted successfully!`);
          closeEditModal();
          loadShows(); // Reload shows
        } else {
          alert('Error deleting show: ' + data.error);
        }
      })
      .catch(error => {
        console.error('üí• Error deleting show:', error);
        alert('Error deleting show: ' + error.message);
      });
    }

    function deleteShowFromCard(showId) {
      const show = userShows.find(s => s.id === showId);
      if (!show) {
        alert('Show not found!');
        return;
      }
      
      const showTitle = show.title;
      const confirmMessage = `Are you sure you want to DELETE "${showTitle}"?\n\nThis will:\n- Remove the show completely\n- Delete all uploaded tracks\n- Free up the time slot\n- This action CANNOT be undone!\n\nType "DELETE" to confirm:`;
      
      const confirmation = prompt(confirmMessage);
      
      if (confirmation !== 'DELETE') {
        alert('Show deletion cancelled.');
        return;
      }
      
      console.log('üóëÔ∏è Starting delete request for show:', showId, 'by user:', userEmail);
      
      // Send delete request
      fetch(`${window.location.protocol}//${window.location.host}/api/shows/${showId}`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ userEmail: userEmail })
      })
      .then(response => {
        console.log('üóëÔ∏è Delete response status:', response.status, response.statusText);
        return response.json();
      })
      .then(data => {
        console.log('üóëÔ∏è Delete response data:', data);
        if (data.success) {
          alert(`Show "${showTitle}" has been deleted successfully!`);
          // Remove the show from userShows array
          userShows = userShows.filter(s => s.id !== showId);
          // Re-render the shows list to remove the deleted show card
          displayShows(userShows);
          populateShowSelect(userShows);
        } else {
          alert('Error deleting show: ' + data.error);
        }
      })
      .catch(error => {
        console.error('üí• Error deleting show:', error);
        alert('Error deleting show: ' + error.message);
      });
    }

    // Close modal when clicking outside
    document.getElementById('editModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeEditModal();
      }
    });

    function playShow(showId) {
      alert(`Show preview functionality coming soon! Show ID: ${showId}`);
    }

    // Load shows when page loads
    loadShows();
  </script>
</body>
</html>
